<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Simulaci√≥n - Stage</title>
  <style>
    html, body {
      margin:0; padding:0; overflow:hidden;
      background:black;
      height:100%; width:100%;
    }
    canvas {
      display:block;
      width:100vw;
      height:100vh;
      object-fit:cover;
    }
  </style>
</head>
<body>
  <canvas id="cv"></canvas>
  <script type="module">
  import { busOn } from './app.js';

  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  let fA = new Image(), fB = new Image(), fReady = false, fx = 0;
  let escenario = 'playa', running = false, paused = false, velKmh = 3.0;

  // ‚õèÔ∏è Cargar im√°genes desde el panel
  const fondos = {
    playa: ['./fondos/playa3.png','./fondos/playa4.png'],
    ciudad:['./fondos/ciudad3.png','./fondos/ciudad4.png'],
    futbol:['./fondos/futbol3.png','./fondos/futbol4.png'],
    montana:['./fondos/montana3.png','./fondos/montana4.png']
  };

  function cargarFondos(esc) {
    const pair = fondos[esc] || fondos.playa;
    fReady = false;
    fA = new Image(); fB = new Image();
    let c = 0;
    fA.onload = () => { if (++c === 2) fReady = true; };
    fB.onload = () => { if (++c === 2) fReady = true; };
    fA.src = pair[0]; fB.src = pair[1];
  }
  cargarFondos(escenario);

  // üìè Ajuste de tama√±o del canvas
  function resize() {
    cv.width = window.innerWidth;
    cv.height = window.innerHeight;
  }
  window.addEventListener('resize', resize);
  resize();

  // üé• Dibujar fondo desplazable A‚ÜíB‚ÜíA‚ÜíB‚Ä¶
  function drawFondo(dt) {
    if (!fReady) return;
    ctx.clearRect(0, 0, cv.width, cv.height);

    const scale = cv.height / fA.height;
    const wA = fA.width * scale;
    const wB = fB.width * scale;
    const h = cv.height;
    const totalW = wA + wB;

    const pxPerSec = (running && !paused) ? (velKmh / 3.6) * 70 : 0;
    fx = (fx + pxPerSec * dt) % totalW;
    const startX = -fx;

    for (let x = startX; x < cv.width; x += totalW) {
      ctx.drawImage(fA, 0, 0, fA.width, fA.height, Math.round(x), 0, wA, h);
      ctx.drawImage(fB, 0, 0, fB.width, fB.height, Math.round(x + wA), 0, wB, h);
    }
  }

  // üîÑ Bucle de animaci√≥n
  let last = performance.now();
  function loop(now) {
    const dt = (now - last) / 1000;
    last = now;
    drawFondo(dt);
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // üîå Comunicaci√≥n con el panel
  busOn(msg => {
    if (msg.type === 'escenario') {
      escenario = msg.value;
      cargarFondos(escenario);
    } else if (msg.type === 'vel') {
      velKmh = msg.value;
    } else if (msg.type === 'start') {
      running = true; paused = false; velKmh = msg.vel;
    } else if (msg.type === 'pause') {
      paused = true;
    } else if (msg.type === 'resume') {
      paused = false;
    } else if (msg.type === 'stop') {
      running = false; paused = false;
    }
  });

  // Comunicar que el stage est√° listo
  window.opener?.postMessage({ type: 'hello-from-stage' }, '*');
  </script>
</body>
</html>
