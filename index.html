<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Simulador de Caminata - Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; font-family: system-ui, Arial; }
    body {
      margin: 0; background: #0f1115; color: #e5e7eb;
      display: grid; grid-template-columns: 320px 1fr; grid-template-rows: auto 1fr;
      gap: 16px; padding: 16px; height: 100vh; box-sizing: border-box;
    }
    .card { background: #161a21; border: 1px solid #242938; border-radius: 14px; padding: 14px }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap }
    button, select, input {
      background: #1d2230; color: #e5e7eb; border: 1px solid #2a3144; border-radius: 10px; padding: 8px 12px;
    }
    button:disabled { opacity: .5 }
    h1 { font-size: 20px; margin: 0 0 8px }
    h2 { font-size: 16px; margin: 0 0 8px; color: #9bb0ff }
    .metrics { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px }
    .metrics .card { text-align: center }
    .big { font-size: 20px; font-weight: 700 }
    canvas { background: #000; border-radius: 12px; width: 100%; height: 100%; display: block; }
    table { width: 100%; border-collapse: collapse }
    td,th { border-bottom: 1px solid #23283a; padding: 6px 8px; font-size: 13px }
    .muted { opacity: .8 }

    /* Historial con scroll (~5 filas) */
    .hist-wrapper {
      max-height: 210px;
      overflow-y: auto;
      scrollbar-width: thin;
    }
  </style>
</head>
<body>
  <!-- Panel -->
  <div class="card" style="grid-row:1">
    <h1>Panel de Control</h1>
    <div class="row">
      <label>Paciente</label>
      <input id="paciente" placeholder="Nombre o c√≥digo" />
    </div>
    <div class="row" style="margin-top:8px">
      <label>Escenario</label>
      <select id="escenario">
        <option value="bosque">Bosque</option>
        <option value="ciudad">Ciudad</option>
        <option value="futbol">F√∫tbol</option>
        <option value="montana">Monta√±a</option>
      </select>
      <label>Velocidad (km/h)</label>
      <input id="vel" type="number" min="0" step="0.1" value="3.0" style="width:90px">
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnIniciar">Iniciar</button>
      <button id="btnPausar" disabled>Pausar</button>
      <button id="btnContinuar" disabled>Continuar</button>
      <button id="btnDetener" disabled>Guardar</button>
      <button id="btnStage">Abrir Stage</button>
    </div>

    <!-- Fila original: Tiempo / Distancia / Sesiones -->
    <div class="metrics" style="margin-top:12px">
      <div class="card"><div class="muted">Tiempo</div><div class="big" id="mTiempo">00:00</div></div>
      <div class="card"><div class="muted">Distancia</div><div class="big"><span id="mKm">0.00</span> km</div></div>
      <div class="card"><div class="muted">Sesiones</div><div class="big" id="mSes">0</div></div>
    </div>

    <!-- Nueva fila debajo: Pasos / Frecuencia -->
    <div class="metrics" style="margin-top:8px; grid-template-columns: repeat(2,1fr);">
      <div class="card">
        <div class="muted">Pasos</div>
        <div class="big" id="mPasos">0</div>
      </div>
      <div class="card">
        <div class="muted">Frecuencia</div>
        <!-- valor inicial en reposo (60) -->
        <div class="big"><span id="mFreq">60</span> bpm</div>
      </div>
    </div>
  </div>

  <!-- Historial -->
  <div class="card" style="grid-row:2">
    <h2>Historial del Paciente</h2>
    <div class="hist-wrapper">
      <table>
        <thead><tr><th>Fecha</th><th>Escenario</th><th>Duraci√≥n</th><th>Km</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Canvas -->
  <div class="card" style="grid-column:2; grid-row:1 / span 2; display:flex; flex-direction:column;">
    <h2>Simulaci√≥n</h2>
    <canvas id="stick" width="800" height="400"></canvas>
  </div>

  <script type="module">
    import { formatMMSS, Store, busSend, busOn, openStage } from './app.js';

    let running=false, paused=false, t0=0, acc=0, km=0, fx=0;
    let phase=0, phaseAccum=0, pasos=0;
    const HR_BASE = 60;  // reposo; a 5 km/h ser√° 75

    const ctx=document.getElementById('stick').getContext('2d');
    const paciente=document.getElementById('paciente');
    const vel=document.getElementById('vel');
    const esc=document.getElementById('escenario');
    const mTiempo=document.getElementById('mTiempo');
    const mKm=document.getElementById('mKm');
    const mSes=document.getElementById('mSes');
    const tbody=document.getElementById('tbody');
    const mPasos=document.getElementById('mPasos');
    const mFreq=document.getElementById('mFreq');

    const btnIniciar   = document.getElementById('btnIniciar');
    const btnPausar    = document.getElementById('btnPausar');
    const btnContinuar = document.getElementById('btnContinuar');
    const btnDetener   = document.getElementById('btnDetener');
    const btnStage     = document.getElementById('btnStage');

    // Fondos del panel (stickman)
    const fondos={
      bosque:['./fondos/bosque1.png','./fondos/bosque2.png'],
      ciudad:['./fondos/ciudad1.png','./fondos/ciudad2.png'],
      futbol:['./fondos/futbol1.png','./fondos/futbol2.png'],
      montana:['./fondos/montana1.png','./fondos/montana2.png']
    };

    // --- Sonidos ---
    const sonidos = {
      bosque:  new Audio('./audio/montana.mp3'),
      ciudad: new Audio('./audio/ciudad.mp3'),
      futbol: new Audio('./audio/futbol.mp3'),
      montana:new Audio('./audio/montana.mp3')
    };

    for (const k in sonidos) {
      sonidos[k].loop = true;
      sonidos[k].volume = 0.5;
    }
    let audioActual = null;

    function cambiarSonido(escName) {
      if (audioActual) audioActual.pause();
      audioActual = sonidos[escName] || null;
      if (audioActual && running && !paused) {
        audioActual.currentTime = 0;
        audioActual.play();
      }
    }

    let fA=new Image(), fB=new Image(), fReady=false;
    function cargarFondos(escena){
      const pair=fondos[escena]||fondos.bosque;
      fReady=false;
      fA=new Image();
      fB=new Image();
      let c=0;
      fA.onload=fB.onload=()=>{if(++c===2)fReady=true};
      fA.src=pair[0];
      fB.src=pair[1];
    }
    cargarFondos(esc.value);

    esc.onchange = () => {
      cargarFondos(esc.value);
      cambiarSonido(esc.value);
      busSend({ type:'escenario', value: esc.value });
    };

    function drawFondo(ctx, speed){
      if(!fReady) return;

      ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);

      const scale = ctx.canvas.height / fA.height;
      const wA = fA.width * scale;
      const wB = fB.width * scale;
      const h  = ctx.canvas.height;
      const totalW = wA + wB;

      const pxPerFrame = (running && !paused ? (speed/3.6) * 50 * (1/60) : 0);
      fx = (fx + pxPerFrame) % totalW;
      const startX = -fx;

      for (let x = startX; x < ctx.canvas.width; x += totalW) {
        ctx.drawImage(fA, 0, 0, fA.width, fA.height, Math.round(x),       0, wA, h);
        ctx.drawImage(fB, 0, 0, fB.width, fB.height, Math.round(x + wA),  0, wB, h);
      }
    }

    function updateHeartRate(speed){
      let hr = HR_BASE;
      if (running && !paused && speed > 0) {
        // 60 + speed*3  ‚Üí a 5 km/h = 75 bpm
        hr = Math.round(HR_BASE + speed * 3);
        if (hr > 180) hr = 180;
      }
      mFreq.textContent = hr.toString();
    }

    function drawStickman(){
      const W=ctx.canvas.width,H=ctx.canvas.height;
      const speed=(running&&!paused)?parseFloat(vel.value):0;

      drawFondo(ctx,speed);

      const s=0.6, hipX=200,hipY=H-80;
      const torso=60*s,head=16*s,thigh=42*s,calf=38*s,upper=34*s,fore=30*s,line=4*s;

      const gait = (running && !paused) ? Math.max(0.15, parseFloat(vel.value) / 9) : 0;

      if (gait > 0) {
        const oldPhase = phase;
        phase += gait * 0.03;
        let delta = phase - oldPhase;
        if (delta < 0) delta += Math.PI * 2;

        phaseAccum += delta;
        const STEP_SIZE = Math.PI;

        while (phaseAccum >= STEP_SIZE) {
          phaseAccum -= STEP_SIZE;
          pasos++;
        }
        mPasos.textContent = pasos.toString();
      }

      const L=phase,R=phase+Math.PI;
      const thL=Math.sin(L)*0.45,cfL=Math.max(0,Math.sin(L+0.5))*0.9;
      const thR=Math.sin(R)*0.45,cfR=Math.max(0,Math.sin(R+0.5))*0.9;
      const uaL=Math.sin(R)*0.4,faL=Math.max(0,Math.sin(R+0.6))*0.8;
      const uaR=Math.sin(L)*0.4,faR=Math.max(0,Math.sin(L+0.6))*0.8;
      ctx.lineCap='round'; ctx.strokeStyle='#000'; ctx.lineWidth=line;
      const neckX=hipX,neckY=hipY-torso;
      function limb(x0,y0,len,a){return{x:x0+Math.sin(a)*len,y:y0+Math.cos(a)*len};}
      ctx.beginPath(); ctx.moveTo(hipX,hipY); ctx.lineTo(neckX,neckY); ctx.stroke();
      ctx.beginPath(); ctx.arc(neckX,neckY-(head+5),head,0,Math.PI*2); ctx.stroke();
      const kL=limb(hipX,hipY,thigh,thL), fL=limb(kL.x,kL.y,calf,thL+cfL);
      const kR=limb(hipX,hipY,thigh,thR), fR=limb(kR.x,kR.y,calf,thR+cfR);
      ctx.beginPath(); ctx.moveTo(hipX,hipY); ctx.lineTo(kL.x,kL.y); ctx.lineTo(fL.x,fL.y); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(hipX,hipY); ctx.lineTo(kR.x,kR.y); ctx.lineTo(fR.x,fR.y); ctx.stroke();
      const eL=limb(neckX,neckY,upper,uaL), hL=limb(eL.x,eL.y,fore,uaL+faL);
      const eR=limb(neckX,neckY,upper,uaR), hR=limb(eR.x,eR.y,fore,uaR+faR);
      ctx.beginPath(); ctx.moveTo(neckX,neckY); ctx.lineTo(eL.x,eL.y); ctx.lineTo(hL.x,hL.y); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(neckX,neckY); ctx.lineTo(eR.x,eR.y); ctx.lineTo(hR.x,hR.y); ctx.stroke();
    }
    (function loop(){drawStickman();requestAnimationFrame(loop)})();

    btnStage.onclick=()=>openStage();
    vel.oninput=()=>busSend({type:'vel',value:parseFloat(vel.value)});

    btnIniciar.onclick=()=>{
      if(running)return;
      running=true;
      paused=false;
      t0=performance.now();
      acc=0;
      km=0;
      pasos=0;
      phase=0;
      phaseAccum=0;
      mPasos.textContent='0';
      mFreq.textContent=HR_BASE.toString();

      btnIniciar.disabled=true;
      btnPausar.disabled=false;
      btnDetener.disabled=false;
      btnContinuar.disabled=true;

      busSend({type:'start',escenario:esc.value,vel:parseFloat(vel.value)});
      cambiarSonido(esc.value);
      if (audioActual) audioActual.play().catch(()=>{});
      tick();
    };

    btnPausar.onclick=()=>{
      if(!running||paused)return;
      paused=true;
      if (audioActual) audioActual.pause();
      acc+=performance.now()-t0;
      btnPausar.disabled=true;
      btnContinuar.disabled=false;
      busSend({type:'pause'});
    };

    btnContinuar.onclick=()=>{
      if(!running||!paused)return;
      paused=false;
      if (audioActual) audioActual.play().catch(()=>{});
      t0=performance.now();
      btnPausar.disabled=false;
      btnContinuar.disabled=true;
      busSend({type:'resume'});
      tick();
    };

    btnDetener.onclick=()=>{
      if(!running)return;

      if (audioActual) {
        audioActual.pause();
        audioActual.currentTime = 0;
      }

      const seg=Math.round(((paused?acc:(acc+performance.now()-t0)))/1000);
      const rec={ts:Date.now(),escenario:esc.value,seg,km};
      const id=paciente.value.trim()||'_anonimo';
      Store.addSesion(id,rec);

      running=false;
      paused=false;
      btnIniciar.disabled=false;
      btnPausar.disabled=true;
      btnContinuar.disabled=true;
      btnDetener.disabled=true;
      mTiempo.textContent='00:00';
      mKm.textContent='0.00';
      km=0;
      acc=0;
      pasos=0;
      mPasos.textContent='0';
      mFreq.textContent=HR_BASE.toString();
      busSend({type:'stop'});
      refreshHist();
    };

    function tick(){
      if(!running)return;
      const elapsed=(paused?acc:(acc+performance.now()-t0));
      const seg=Math.round(elapsed/1000);
      mTiempo.textContent=formatMMSS(seg);
      km=parseFloat(vel.value)*(seg/3600);
      mKm.textContent=km.toFixed(2);

      const speed = (running && !paused) ? parseFloat(vel.value) : 0;
      updateHeartRate(speed);

      if(!paused)requestAnimationFrame(tick);
    }

    function refreshHist(){
      const id=paciente.value.trim()||'_anonimo';
      // üîΩ ordenar por fecha: m√°s reciente primero
      const list=Store.getHistorial(id)
        .slice()
        .sort((a,b)=>b.ts - a.ts);

      mSes.textContent=list.length;
      tbody.innerHTML=list.map(it=>`
        <tr><td>${new Date(it.ts).toLocaleString()}</td>
        <td>${it.escenario}</td>
        <td>${formatMMSS(it.seg)}</td>
        <td>${it.km.toFixed(2)}</td></tr>`).join('');
    }
    paciente.oninput=refreshHist;refreshHist();
  </script>
</body>
</html>
