<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Simulador de Caminata - Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; font-family: system-ui, Arial; }
    body {
      margin: 0; background: #0f1115; color: #e5e7eb;
      display: grid; grid-template-columns: 320px 1fr; grid-template-rows: auto 1fr;
      gap: 16px; padding: 16px; height: 100vh; box-sizing: border-box;
    }
    .card { background: #161a21; border: 1px solid #242938; border-radius: 14px; padding: 14px }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap }
    button, select, input {
      background: #1d2230; color: #e5e7eb; border: 1px solid #2a3144; border-radius: 10px; padding: 8px 12px;
    }
    button:disabled { opacity: .5 }
    h1 { font-size: 20px; margin: 0 0 8px }
    h2 { font-size: 16px; margin: 0 0 8px; color: #9bb0ff }
    .metrics { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px }
    .metrics .card { text-align: center }
    .big { font-size: 20px; font-weight: 700 }
    canvas { background: #000; border-radius: 12px; width: 100%; height: 100%; display: block; }
    table { width: 100%; border-collapse: collapse }
    td,th { border-bottom: 1px solid #23283a; padding: 6px 8px; font-size: 13px }
    .muted { opacity: .8 }
  </style>
</head>
<body>
  <!-- Panel -->
  <div class="card" style="grid-row:1">
    <h1>Panel de Control</h1>
    <div class="row">
      <label>Paciente</label>
      <input id="paciente" placeholder="Nombre o c칩digo" />
    </div>
    <div class="row" style="margin-top:8px">
      <label>Escenario</label>
      <select id="escenario">
        <option value="playa">Playa</option>
        <option value="ciudad">Ciudad</option>
        <option value="futbol">F칰tbol</option>
        <option value="montana">Monta침a</option>
      </select>
      <label>Velocidad (km/h)</label>
      <input id="vel" type="number" min="0" step="0.1" value="3.0" style="width:90px">
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnIniciar">Iniciar</button>
      <button id="btnPausar" disabled>Pausar</button>
      <button id="btnContinuar" disabled>Continuar</button>
      <button id="btnDetener" disabled>Guardar</button>
      <button id="btnStage">Abrir Stage</button>
    </div>

    <div class="metrics" style="margin-top:12px">
      <div class="card"><div class="muted">Tiempo</div><div class="big" id="mTiempo">00:00</div></div>
      <div class="card"><div class="muted">Distancia</div><div class="big"><span id="mKm">0.00</span> km</div></div>
      <div class="card"><div class="muted">Sesiones</div><div class="big" id="mSes">0</div></div>
    </div>
  </div>

  <!-- Historial -->
  <div class="card" style="grid-row:2">
    <h2>Historial del Paciente</h2>
    <table>
      <thead><tr><th>Fecha</th><th>Escenario</th><th>Duraci칩n</th><th>Km</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- Canvas -->
  <div class="card" style="grid-column:2; grid-row:1 / span 2; display:flex; flex-direction:column;">
    <h2>Simulaci칩n</h2>
    <canvas id="stick" width="800" height="400"></canvas>
  </div>

  <script type="module">
    import { formatMMSS, Store, busSend, busOn, openStage } from './app.js';

    let running=false, paused=false, t0=0, acc=0, km=0, fx=0;
    const ctx=document.getElementById('stick').getContext('2d');
    const paciente=document.getElementById('paciente');
    const vel=document.getElementById('vel');
    const esc=document.getElementById('escenario');
    const mTiempo=document.getElementById('mTiempo');
    const mKm=document.getElementById('mKm');
    const mSes=document.getElementById('mSes');
    const tbody=document.getElementById('tbody');

    const fondos={
      playa: ['./fondos/playa1.png','./fondos/playa2.png'],
      ciudad:['./fondos/ciudad1.png','./fondos/ciudad2.png'],
      futbol:['./fondos/futbol1.png','./fondos/futbol2.png'],
      montana:['./fondos/montana1.png','./fondos/montana2.png']
    };



    // --- Sonidos ---
    const sonidos = {
      playa:  new Audio('./audio/playa.mp3'),
      ciudad: new Audio('./audio/ciudad.mp3'),
      futbol: new Audio('./audio/futbol.mp3'),
      montana:new Audio('./audio/montana.mp3')
    };

    // Configuraci칩n inicial
    for (const k in sonidos) {
      sonidos[k].loop = true;        // que se repita
      sonidos[k].volume = 0.5;       // volumen medio
    }
    let audioActual = null;

    // Cambiar sonido al cambiar escenario
    function cambiarSonido(esc) {
      if (audioActual) audioActual.pause();
      audioActual = sonidos[esc] || null;
      if (audioActual && running && !paused) {
        audioActual.currentTime = 0;
        audioActual.play();
      }
    }



    let fA=new Image(), fB=new Image(), fReady=false;
    function cargarFondos(escena){
      const pair=fondos[escena]||fondos.playa;
      fReady=false; 
      fA=new Image(); 
      fB=new Image();
      let c=0; 
      fA.onload=fB.onload=()=>{if(++c===2)fReady=true};
      fA.src=pair[0]; 
      fB.src=pair[1];
    }
    cargarFondos(esc.value);

    esc.onchange = () => {
      cargarFondos(esc.value);                          // cambia las im치genes
      cambiarSonido(esc.value);                         // 游댉 cambia el sonido del escenario
      busSend({ type:'escenario', value: esc.value });  // avisa al Stage
    };

// Fondo sincronizado
function drawFondo(ctx, speed){
  if(!fReady) return;

  // limpiar
  ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);

  // Escala por altura (fit-height)
  const scale = ctx.canvas.height / fA.height;
  const wA = fA.width * scale;
  const wB = fB.width * scale;
  const h  = ctx.canvas.height;
  const totalW = wA + wB;

  // Avance por frame (usa A+B como per칤odo)
  const pxPerFrame = (running && !paused ? (speed/3.6) * 50 * (1/60) : 0);
  fx = (fx + pxPerFrame) % totalW;     // desplazamiento positivo
  const startX = -fx;                  // dibujar desde -offset

  // Tiling: ... | A | B | A | B | ... hasta cubrir el canvas
  for (let x = startX; x < ctx.canvas.width; x += totalW) {
    // A
    ctx.drawImage(fA, 0, 0, fA.width, fA.height, Math.round(x),       0, wA, h);
    // B
    ctx.drawImage(fB, 0, 0, fB.width, fB.height, Math.round(x + wA),  0, wB, h);
  }
}

    // Stickman simple y fluido
    let phase=0;
    function drawStickman(){
      const W=ctx.canvas.width,H=ctx.canvas.height;
      const speed=(running&&!paused)?parseFloat(vel.value):0;
      drawFondo(ctx,speed);
      const s=0.6, hipX=200,hipY=H-80;
      const torso=60*s,head=16*s,thigh=42*s,calf=38*s,upper=34*s,fore=30*s,line=4*s;
      // Zancada m치s lenta y cadencia m치s baja
      const gait = (running && !paused) ? Math.max(0.15, parseFloat(vel.value) / 9) : 0; // antes /7
      phase += gait * 0.03; // antes 0.10

      const L=phase,R=phase+Math.PI;
      const thL=Math.sin(L)*0.45,cfL=Math.max(0,Math.sin(L+0.5))*0.9;
      const thR=Math.sin(R)*0.45,cfR=Math.max(0,Math.sin(R+0.5))*0.9;
      const uaL=Math.sin(R)*0.4,faL=Math.max(0,Math.sin(R+0.6))*0.8;
      const uaR=Math.sin(L)*0.4,faR=Math.max(0,Math.sin(L+0.6))*0.8;
      ctx.lineCap='round'; ctx.strokeStyle='#000'; ctx.lineWidth=line;
      const neckX=hipX,neckY=hipY-torso;
      function limb(x0,y0,len,a){return{x:x0+Math.sin(a)*len,y:y0+Math.cos(a)*len};}
      ctx.beginPath(); ctx.moveTo(hipX,hipY); ctx.lineTo(neckX,neckY); ctx.stroke();
      ctx.beginPath(); ctx.arc(neckX,neckY-(head+5),head,0,Math.PI*2); ctx.stroke();
      const kL=limb(hipX,hipY,thigh,thL), fL=limb(kL.x,kL.y,calf,thL+cfL);
      const kR=limb(hipX,hipY,thigh,thR), fR=limb(kR.x,kR.y,calf,thR+cfR);
      ctx.beginPath(); ctx.moveTo(hipX,hipY); ctx.lineTo(kL.x,kL.y); ctx.lineTo(fL.x,fL.y); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(hipX,hipY); ctx.lineTo(kR.x,kR.y); ctx.lineTo(fR.x,fR.y); ctx.stroke();
      const eL=limb(neckX,neckY,upper,uaL), hL=limb(eL.x,eL.y,fore,uaL+faL);
      const eR=limb(neckX,neckY,upper,uaR), hR=limb(eR.x,eR.y,fore,uaR+faR);
      ctx.beginPath(); ctx.moveTo(neckX,neckY); ctx.lineTo(eL.x,eL.y); ctx.lineTo(hL.x,hL.y); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(neckX,neckY); ctx.lineTo(eR.x,eR.y); ctx.lineTo(hR.x,hR.y); ctx.stroke();
    }
    (function loop(){drawStickman();requestAnimationFrame(loop)})();

    // Control botones
    btnStage.onclick=()=>openStage();
    vel.oninput=()=>busSend({type:'vel',value:parseFloat(vel.value)});
    btnIniciar.onclick=()=>{
      if(running)return;
      running=true;
      paused=false;
      t0=performance.now();
      acc=0;
      km=0;
      btnIniciar.disabled=true;
      btnPausar.disabled=false;
      btnDetener.disabled=false;
      busSend({type:'start',escenario:esc.value,vel:parseFloat(vel.value)});
      cambiarSonido(esc.value);                 // selecciona el audio del escenario
      if (audioActual) audioActual.play().catch(()=>{});  // reproduce
      tick();
    };

    btnPausar.onclick=()=>{
      if(!running||paused)return;
      paused=true;
      if (audioActual) audioActual.pause();     // pausa
      acc+=performance.now()-t0;
      btnPausar.disabled=true;
      btnContinuar.disabled=false;
      busSend({type:'pause'});
    };


    btnContinuar.onclick=()=>{
      if(!running||!paused)return;
      paused=false;
      if (audioActual) audioActual.play().catch(()=>{});  // reanuda
      t0=performance.now();
      btnPausar.disabled=false;
      btnContinuar.disabled=true;
      busSend({type:'resume'});
      tick();
    };

    btnDetener.onclick=()=>{
      if(!running)return;

      if (audioActual) {                              // 游댉 detiene y reinicia el audio
        audioActual.pause();
        audioActual.currentTime = 0;
      }

      const seg=Math.round(((paused?acc:(acc+performance.now()-t0)))/1000);
      const rec={ts:Date.now(),escenario:esc.value,seg,km};
      const id=paciente.value.trim()||'_anonimo';
      Store.addSesion(id,rec);

      running=false;
      paused=false;
      btnIniciar.disabled=false;
      btnPausar.disabled=true;
      btnContinuar.disabled=true;
      btnDetener.disabled=true;
      mTiempo.textContent='00:00';
      mKm.textContent='0.00';
      km=0;
      acc=0;
      busSend({type:'stop'});
      refreshHist();
    };

    function tick(){
      if(!running)return;
      const elapsed=(paused?acc:(acc+performance.now()-t0));
      const seg=Math.round(elapsed/1000);
      mTiempo.textContent=formatMMSS(seg);
      km=parseFloat(vel.value)*(seg/3600);
      mKm.textContent=km.toFixed(2);
      if(!paused)requestAnimationFrame(tick);
    }

    function refreshHist(){
      const id=paciente.value.trim()||'_anonimo';
      const list=Store.getHistorial(id);
      mSes.textContent=list.length;
      tbody.innerHTML=list.map(it=>`
        <tr><td>${new Date(it.ts).toLocaleString()}</td>
        <td>${it.escenario}</td>
        <td>${formatMMSS(it.seg)}</td>
        <td>${it.km.toFixed(2)}</td></tr>`).join('');
    }
    paciente.oninput=refreshHist;refreshHist();
  </script>
</body>
</html>
